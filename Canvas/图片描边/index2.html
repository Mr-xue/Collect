<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Marching squares算法提取图片轮廓</title>
        <style>
            * {
                margin: 0;
                padding: 0;
            }
            canvas {
                display: block;
                margin: 20px auto;
                outline: 1px solid teal;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <script>
            document.addEventListener('DOMContentLoaded', function () {

                // 读取图片信息
                const img = new Image();
                img.src = './imgs/demo.png';
                img.onload = function () {
                    // 创建Canvas元素
                    const canvas = document.querySelector('#canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    // 获取像素数据
                    const imageData = ctx.getImageData(
                        0,
                        0,
                        canvas.width,
                        canvas.height
                    );
                    const data = imageData.data;

                    // Marching squares算法
                    const contours = [];
                    const threshold = 128;
                    for (let y = 0; y < canvas.height - 1; y++) {
                        for (let x = 0; x < canvas.width - 1; x++) {
                            const i = (y * canvas.width + x) * 4;
                            const j = ((y + 1) * canvas.width + x) * 4;
                            const k = (y * canvas.width + x + 1) * 4;
                            const l = ((y + 1) * canvas.width + x + 1) * 4;
                            const v1 = data[i] > threshold;
                            const v2 = data[j] > threshold;
                            const v3 = data[k] > threshold;
                            const v4 = data[l] > threshold;
                            const index = (v1 << 3) | (v2 << 2) | (v3 << 1) | v4;
                            const dx1 = [0, 0, 1, -1][index];
                            const dy1 = [0, 1, 0, 0][index];
                            const dx2 = [0, -1, 0, 1][index];
                            const dy2 = [0, 0, 1, -1][index];
                            if (index !== 0 && index !== 15) {
                                contours.push([x + dx1 + 0.5, y + dy1 + 0.5]);
                                if (index === 5 || index === 10) {
                                    contours.push([x + 0.5, y + 0.5]);
                                }
                                contours.push([x + dx2 + 0.5, y + dy2 + 0.5]);
                            }
                        }
                    }

                    // 绘制路径
                    const path = new Path2D();
                    path.moveTo(...contours[0]);
                    for (let i = 1; i < contours.length; i++) {
                        path.lineTo(...contours[i]);
                    }
                    ctx.stroke(path);
                };
            })
        </script>
    </body>
</html>
